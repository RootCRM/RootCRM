<% include include/main-header %>
<link href="css/bootstrap.datepicker.css" type="text/css" rel="stylesheet">
<!-- page specific css -->
<link rel="stylesheet" href="css/basictable.css">
</head>
<style>
.box-primary h4{
margin: 7px 5px 0px 0px;
border-radius: 3px;
padding: 9px;
border-bottom: 1px solid #ddd;
font-size: 20px;
}
</style>
</head>
<body class="hold-transition skin-blue sidebar-mini">
	<div class="wrapper">
		<!-- Header Starts here-->
  		<% include include/header %>
  		<!-- Header Ends here-->
  		
  		<!-- Sidebar Starts Here-->
  			<% include include/sidebar %>
    	<!-- Sidebar Ends Here-->
    	
		<!-- Content Wrapper. Contains page content -->
  		<div class="content-wrapper">
    		<!-- Content Header (Page header) -->
    		<section class="content-header">
      			<h1> <% if (typeof contentObj.name !== 'undefined' && contentObj.name !== null) { %><%= contentObj.name %><% } else{	%>Add new<% }%><small>Company</small></h1>
      			<ol class="breadcrumb">
        			<li><a href="<%= backendDirectory %>/index"><i class="fa fa-dashboard"></i> Home</a></li>
        			<li class="active">Company</li>
      			</ol>
    		</section>
    		<!-- Main content -->
    		<section class="content">
				<div class="row">
					<section class="content">
						<div class="nav-tabs-custom">
								<% if (typeof queryStr !== 'undefined' && queryStr !== null) {
    								if(queryStr.error_msg) {	%>
									<div class="alert alert-danger alert-dismissable">
             							<button aria-hidden="true" data-dismiss="alert" class="close" type="button">×</button>
                						<%= queryStr.error_msg %>
            						</div>
            						<% }
           							if(queryStr.success_msg) {	%>
										<div class="alert alert-success alert-dismissable">
             								<button aria-hidden="true" data-dismiss="alert" class="close" type="button">×</button>
                							<%= queryStr.success_msg %>
            							</div>
            						<%	}
            					}	%>
            				<!-- Tabs within a box -->
           					<ul class="nav nav-tabs pull-left">
            					<li class="active"><a href="#first" data-toggle="tab">Details</a></li>
            					<% if (typeof contentObj._id !== 'undefined' && contentObj._id !== null) { %>
           						<li><a href="#second" data-toggle="tab">Notes</a></li>
           						<% } %>
							</ul>
            				<div class="tab-content ">
            					
              					<div class="chart tab-pane active" id="first" >
              					<form class="form-horizontal" action="<%= backendDirectory %>/save/customer" method="POST" id="contentForm">
            						<input type="hidden" class="form-control" id="table_name" name="table_name" value="Companies">
      								<input type="hidden" class="form-control" id="unique_field" name="unique_field" value="account_Number">
      								<input type="hidden" class="form-control" id="id" name="id" value="<% if (typeof contentObj._id !== 'undefined' && contentObj._id !== null) { %><%= contentObj._id %><% } %>">
      								<input type="hidden" class="form-control" id="editorField" name="editorField" value="<% if (typeof editorField !== 'undefined' && editorField !== null) { %><%= editorField %><% }else{ %>_id<% } %>">
      								<input type="hidden" class="form-control" id="editorValue" name="editorValue" value="<% if (typeof editorValue !== 'undefined' && editorValue !== null) { %><%= editorValue %><% } %>">
            						<input type="hidden" class="form-control" id="data" name="data" value="">
            						
									<div class="row" STYLE="margin-top:10px;">
										<div class="col-xs-6">
          									<div class="box box-primary">
		    									<h4>Main Details</h4>
            									<div class="box-body">
														<div class="row">
           		  											<div class=" col-sm-12 col-lg-11">
   																<div class="form-group">
    																<label for="" class="col-sm-3 control-label">Company Name <sup class="required">*</sup></label>
    																<div class="col-sm-9">
      																	<input type="text" class="form-control" id="Company_Name" name="Company_Name" value="<% if (typeof contentObj.Company_Name !== 'undefined' && contentObj.Company_Name !== null) { %><%= contentObj.Company_Name %><% } %>">
    																</div>
  																</div>
  																<div class="form-group">
    																<label for="" class="col-sm-3 control-label">Account Number <sup class="required">*</sup></label>
    																<div class="col-sm-6">
      																	<input type="text" class="form-control" id="account_Number" name="account_Number" value="<% if (typeof contentObj.account_Number !== 'undefined' && contentObj.account_Number !== null) { %><%= contentObj.account_Number %><% } %>">
    																</div>
  																	<div class="col-sm-3">
																		<label><input id="inactive" name="inactive" value="false" type="checkbox" <% if (typeof contentObj.inactive !== 'undefined' && contentObj.inactive !== null && contentObj.inactive == true) { %>checked<% } %>> Inactive</label>
    			  													</div>
  																</div>
  																<div class="form-group">
    																<label for="" class="col-sm-3 control-label">Follow Up Date </label>
    																<div class="col-sm-9">
      																	<input type="text" class="col-sm-4 datepicker form-control" id="followup_date" name="followup_date" data-date-format="dd/mm/yyyy"  readonly value="<% if (typeof contentObj.followup_date !== 'undefined' && contentObj.followup_date !== null) { %><%= contentObj.followup_date %><% } %>">
    																</div>
  																</div>
   															</div>
       			 										</div>
             									</div>
          									</div>
										</div>
										<div class="col-xs-6">
          									<div class="box box-primary">
		    									<h4>Contact Details</h4>
            									<div class="box-body">
														<div class="row">
           		  											<div class=" col-sm-12 col-lg-11">
   																<div class="form-group">
    																<label for="" class="col-sm-3 control-label">First name </label>
    																<div class="col-sm-9">
      																	<input type="text" class="form-control" id="contact_firstname" name="contact_firstname" value="<% if (typeof contentObj.contact_firstname !== 'undefined' && contentObj.contact_firstname !== null) { %><%= contentObj.contact_firstname %><% } %>">
    																</div>
  																</div>
  																<div class="form-group">
    																<label for="" class="col-sm-3 control-label">Last name </label>
    																<div class="col-sm-9">
      																	<input type="text" class="form-control" id="contact_Lastname" name="contact_Lastname" value="<% if (typeof contentObj.contact_Lastname !== 'undefined' && contentObj.contact_Lastname !== null) { %><%= contentObj.contact_Lastname %><% } %>">
    																</div>
  																</div>
  																<div class="form-group">
    																<label for="" class="col-sm-3 control-label">Email</label>
    																<div class="col-sm-9">
      																	<input type="text" class="form-control" id="email_address" name="email_address" value="<% if (typeof contentObj.email_address !== 'undefined' && contentObj.email_address !== null) { %><%= contentObj.email_address %><% } %>">
    																</div>
  																</div>
   															</div>
       			 										</div>
            									</div>
          									</div>
										</div>
									</div>
	  								<div class="row" STYLE="margin-top:10px;">
										<div class="col-xs-6">
          									<div class="box box-primary">
		    									<h4>Address</h4>
            									<div class="box-body">
       		 											<div class="row">
           		  											<div class=" col-sm-12 col-lg-11">
   																<div class="form-group">
    																<label for="" class="col-sm-3 control-label">Address 1 <span style="color:#6E829B">*</span></label>
    																<div class="col-sm-9">
      																	<input type="text" class="form-control" id="address_line_1"  name="address_line_1" value="<% if (typeof contentObj.address_line_1 !== 'undefined' && contentObj.address_line_1 !== null) { %><%= contentObj.address_line_1 %><% } %>">
    																</div>
  																</div>
  																<div class="form-group">
    																<label for="" class="col-sm-3 control-label">Address 2</label>
    																<div class="col-sm-9">
      																	<input type="text" class="form-control" id="address_line_2"  name="address_line_2" value="<% if (typeof contentObj.address_line_2 !== 'undefined' && contentObj.address_line_2 !== null) { %><%= contentObj.address_line_2 %><% } %>">
    																</div>
  																</div>
  																<div class="form-group">
    																<label for="" class="col-sm-3 control-label">City</label>
    																<div class="col-sm-9">
      																	<input type="text" class="form-control" id="city_or_town" name="city_or_town" value="<% if (typeof contentObj.city_or_town !== 'undefined' && contentObj.city_or_town !== null) { %><%= contentObj.city_or_town %><% } %>">
    																</div>
  																</div>
  																<div class="form-group">
    																<label for="" class="col-sm-3 control-label">County</label>
    																<div class="col-sm-9">
      																	<input type="text" class="form-control" id="county_or_state" name="county_or_state" value="<% if (typeof contentObj.county_or_state !== 'undefined' && contentObj.county_or_state !== null) { %><%= contentObj.county_or_state %><% } %>">
    																</div>
  																</div>
																<div class="form-group">
    																<label for="" class="col-sm-3 control-label">Post Code</label>
    																<div class="col-sm-9">
      																	<input type="text" class="form-control" id="post_zip_code" name="post_zip_code" value="<% if (typeof contentObj.post_zip_code !== 'undefined' && contentObj.post_zip_code !== null) { %><%= contentObj.post_zip_code %><% } %>">
    																</div>
  																</div>
  																<div class="form-group">
    																<label for="" class="col-sm-3 control-label">Telephone</label>
    																<div class="col-sm-9">
      																	<input type="text" class="form-control" id="telephone" name="telephone" value="<% if (typeof contentObj.telephone !== 'undefined' && contentObj.telephone !== null) { %><%= contentObj.telephone %><% } %>">
    																</div>
  																</div>
  																<div class="form-group">
    																<label for="" class="col-sm-3 control-label">Fax</label>
    																<div class="col-sm-9">
      																	<input type="text" class="form-control" id="fax" name="fax" value="<% if (typeof contentObj.fax !== 'undefined' && contentObj.fax !== null) { %><%= contentObj.fax %><% } %>">
    																</div>
  																</div>
  																<div class="form-group">
    																<label for="" class="col-sm-3 control-label">Country</label>
    																<div class="col-sm-9">
      																	<input type="text" class="form-control" id="country" name="country" value="<% if (typeof contentObj.country !== 'undefined' && contentObj.country !== null) { %><%= contentObj.country %><% } %>">
    																</div>
  																</div>
  															</div>
       			 										</div>
												</div>
          									</div>
										</div>
										<div class="col-xs-6">
          									<div class="box box-primary">
		    									<h4>Other Info</h4>
            									<div class="box-body">
														<div class="row">
           		  											<div class=" col-sm-12 col-lg-11">
           		  												<div class="form-group ">
																	<label class="col-sm-3 control-label">&nbsp;</label>
																	<div class=" col-sm-9">
																	<label>	<input  name="is_supplier" type="checkbox" value="true" id="is_supplier" <% if (typeof contentObj.is_supplier !== 'undefined' && contentObj.is_supplier !== null && contentObj.is_supplier == true) { %>checked<% } %> >
								 									Supplier	</label>
								 									</div>
																	</div>	
   																<div class="form-group">
    																<label for="" class="col-sm-3 control-label">Relation</label>
    																<div class="col-sm-9">
      																	<input type="text" class="form-control" id="relationship" name="relationship" placeholder="" value="<% if (typeof contentObj.relationship !== 'undefined' && contentObj.relationship !== null) { %><%= contentObj.relationship %><% } %>">
    																</div>
  																</div>
																<div class="form-group">
    																<label for="" class="col-sm-3 control-label">Referred By</label>
    																<div class="col-sm-9">
      																	<input type="text" class="form-control" id="referred_by" name="referred_by" placeholder="" value="<% if (typeof contentObj.referred_by !== 'undefined' && contentObj.referred_by !== null) { %><%= contentObj.referred_by %><% } %>">
    																</div>
  																</div>
  																<div class="form-group">
    																<label for="" class="col-sm-3 control-label">Comments</label>
    																<div class="col-sm-9">
      																	<textarea name="comments" class="form-control" rows="4" id="comments"><% if (typeof contentObj.comments !== 'undefined' && contentObj.comments !== null) { %><%= contentObj.comments %><% } %></textarea>
    																</div>
  																</div>
   															</div>
       			 										</div>
             									</div>
          									</div>
										</div>
									</div>
									
										<div class="col-md-12 col-lg-12" align="center">
               								<div class="submit-btn-setting"> <button type="submit" class="btn btn-primary btn-color margin-right-5 btn-sm">Submit</button>
               								<% if (typeof contentObj._id !== 'undefined' && contentObj._id !== null) {	%>
               									<a href="<%= backendDirectory %>/list/customers" class="btn btn-danger btn-sm">Cancel</a>
               								<%	}else{	%>
               									<button type="reset" class="btn btn-danger btn-sm">Reset</button>
               								<% } %>
               								</div>
               							</div>
									</form>
	  							</div>
	  							<% if (typeof contentObj._id !== 'undefined' && contentObj._id !== null) { %>
              					<div class="chart tab-pane" id="second" >
              						<div class="col-sm-12" style="margin-top:20px;">
              							<a title="Add new note" onClick="$('#addNote').modal('show');" href="javascript:void(0)" class="btn btn-danger">Add new note</a>
              						</div>
              						<div class="content table-responsive table-full-width">
		 								<div class="table-responsive" style="border:none;" >
                        					<table class="table table-striped  table-bordered table-hover custom-tbl-st bt" id="table-breakpoint" style="background-color: rgb(255, 255, 255); border-radius: 4px;" >
												<thead>
													<tr>
		      											<th>Added by</th>
		      											<th>Last Modified</th>	      
			 											<th>Note</th>
			 											<th class="hidden-xs">Action</th>			  
		  											</tr>
												</thead>
		  										<tbody id="notesTable">
		  											
		  										</tbody>
		  									</table>
										</div>
									</div>
              					</div>
              					<% } %>
							</div>
          				</div>
					</section>
    			</div>
			</section>
		</div>

<div class="modal fade" id="addNote" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
	<div class="modal-dialog">
        <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onClick="$('#add_note').val('');">
                  <span aria-hidden="true">x</span></button>
                	<h3 class="modal-title" id="globalMessage">Add new note</h3>
              </div>
              <div class="modal-body">
                <textarea class="form-control" id="add_note" name="add_note" placeholder="Add note here"></textarea>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-danger" onClick="addNewNote()">Save</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" onClick="$('#add_note').val('');">Close</button>
              </div>
            </div>
            <!-- /.modal-content -->
	</div>
</div>

		<!-- Footer Starts Here-->
			<% include include/footer %>
		<!-- Footer Ends Here-->
	</div>
<script src="js/bootstrap.datepicker.js"></script>
<script src="js/jquery.validate.js"></script>

<script src="js/basictable.js"></script>
<script language="javascript">
var collectionStr="Companies";
function save() {
	var row = $(this).parents('.item-row');
	var noteUUID=$('.noteUUID').val();
	var noteField=row.find('.noteField').val();
	
	if(noteUUID!='' && noteField!=''){
		savenote(noteUUID, 'update', noteField);
	}else{
		alert('Please enter note!');
	}
}

function edit() {
	var row = $(this).parents('.item-row');
	row.find('.noteSpan').hide();
	row.find('.noteField').show();
	row.find('.savelink').show();
	row.find('.editlink').hide();
	row.find('.cancellink').show();
	row.find('.removelink').hide();
	
	row.find('.noteField').focus();
}
	
function cancel() {
	var row = $(this).parents('.item-row');
	var noteUUIDStr=row.find('.noteUUID').val();
	if(noteUUIDStr!=''){
		row.find('.noteSpan').show();
		row.find('.noteField').hide();
		row.find('.savelink').hide();
		row.find('.editlink').show();
		row.find('.cancellink').hide();
		row.find('.removelink').show();
	}else{
		row.hide();
	}
}
	
function remove() {
	var row = $(this).parents('.item-row');
	var noteUUIDStr=row.find('.noteUUID').val();
	var Project_uuid="<% if (typeof contentObj._id !== 'undefined' && contentObj._id !== null) { %><%= contentObj._id %><% } %>";
	
	var dataString = 'note_uuid='+noteUUIDStr+'&action=delete&uuid='+Project_uuid+'&table='+collectionStr;
	$.ajax({
		type: "POST",
		dataType: "json",
		url: "<%= backendDirectory %>/savenotes",
		data: dataString,
		cache: false,
		success: function(html){
			row.hide();
 			bind();
		}
	});
}	

function bind() {
	$(".savelink").unbind();
	$(".editlink").unbind();
  	$(".cancellink").unbind();
  	$(".removelink").unbind();
 
  	$(".savelink").click(save);
  	$(".editlink").click(edit);
  	$(".cancellink").click(cancel);
  	$(".removelink").click(remove);
}

function fetchNotes(){
	$("#notesTable").html("");
	var Project_uuid="<% if (typeof contentObj._id !== 'undefined' && contentObj._id !== null) { %><%= contentObj._id %><% } %>";
	var jsonRow=backendDirectory+"/collection_details?id="+Project_uuid+"&collection="+collectionStr;
	$.getJSON(jsonRow,function(html){
			var contentHtml="";
			if(html.aaData){
				var notesArr=html.aaData.notes;
					$.each(notesArr, function(i,row){
						var added_by="Admin";
						if(row.user_name){
							added_by=row.user_name;
						}
						contentHtml+="<tr class='item-row'><td>"+added_by+"</td>";
						contentHtml+="<td>"+row.modified+"<input type='hidden' class='noteUUID form-control' value='"+row.uuid+"' ></td>";
						contentHtml+="<td><span class='noteSpan'>"+row.note+"</span><input type='text' class='noteField form-control' style='display:none;' value='"+row.note+"' ></td>";
						contentHtml+='<td class="hidden-xs"><a href="javascript:void(0)" class="editlink"><i class="fa fa-pencil"></i></a><a href="javascript:void(0)" class="savelink" style="display:none;"><i class="fa fa-save"></i></a>';
						contentHtml+='<a href="javascript:void(0)" class="removelink" style="margin-left:10px;"><i class="fa fa-trash"></i></a><a href="javascript:void(0)" class="cancellink" style="display:none; margin-left:10px;"><i class="fa fa-remove"></i></a></td>';
						contentHtml+="</tr>";
					});
     		}
			$("#notesTable").html(contentHtml);
			bind();
			$('#table-breakpoint').basictable({
    				breakpoint: 751
   			});	
	});
}

function addNewNote(){
	var noteStr= $("#add_note").val();
	savenote('','create', noteStr);
}

function savenote(uuid,actionStr, note){
	var Project_uuid="<% if (typeof contentObj._id !== 'undefined' && contentObj._id !== null) { %><%= contentObj._id %><% } %>";
	var user_id="<% if (typeof authenticatedUser._id !== 'undefined' && authenticatedUser._id !== null) { %><%= authenticatedUser._id %><% } %>";
	var user_name="<% if (typeof authenticatedUser.firstname !== 'undefined' && authenticatedUser.firstname !== null) { %><%= authenticatedUser.firstname %><% } %>";
	user_name+="<% if (typeof authenticatedUser.lastname !== 'undefined' && authenticatedUser.lastname !== null) { %>&nbsp;<%= authenticatedUser.lastname %><% } %>";
	
	var dataString = 'note_uuid='+uuid+'&uuid='+Project_uuid+'&table='+collectionStr+'&action='+actionStr+'&added_by='+user_id+'&note='+note+'&user_name='+user_name;
	$.ajax({
		type: "POST",
		url: "<%= backendDirectory %>/savenotes",
		data: dataString,
		dataType: 'json',
		cache: false,
		success: function(html){
			if(html.success){
				fetchNotes();
				alert(html.success);
			} else if(html.error){
				alert(html.error);
			}
		}
	});
	$('#addNote').modal('hide');
	$('#add_note').val('');
}

	$(function () {
		<% if (typeof contentObj._id !== 'undefined' && contentObj._id !== null) { %>
		fetchNotes();
		<%	}	%>
		
		// validate form on keyup and submit
		$("#contentForm").validate({
			ignore: "",
			onkeyup: false,
			errorClass: 'error',
			validClass: 'valid',
			errorElement: "em",
			errorPlacement: function(error, element) {
				$(element).closest('div').append(error);
			},
			onfocusout: false,
			invalidHandler: function(form, validator) {
				var errors = validator.numberOfInvalids();
				if (errors) {                    
					validator.errorList[0].element.focus();
				}
			},
			rules: {
				Company_Name: { required: true },
				account_Number: { required: true },
				address_line_1: { required: true }
			},
			submitHandler: function(form) {
 				dataAsJson('contentForm', form);
 			}
		});			
		
            // datepicker plugin
            $('.datepicker').datepicker().on('changeDate', function (ev) {
                $(this).datepicker('hide');
            });
	});
	</script>
</body>
</html>
